#!/usr/bin/env ruby

require_relative 'exit_code'

VERSION = "0.3.0"

USAGE = <<~END
Usage:
    
  blossom {--help | --version}
    
  blossom <path/to/programme/file.blsm> 
          {--input <path/to/input/graph/file.bg> | \"<graph text>\"}
          [--output <path/to/output/graph/file.bg>]
          [--trace]
          [--trace-dir <path/to/trace/directory>]
  (unimp) [--ignore-colours | --merge-colours]
  (unimp) [--keep-rationals]
          [--dot | --graphML | --blossom]
  (unimp) [--validate]
END

# Output file
if ARGV.include?("--help") || ARGV.include?("help")
    puts "Blossom Interpreter v#{VERSION}"
    puts
    puts USAGE
    puts
    puts "Arguments:"
    puts
    puts "  help           : Prints this help message."
    puts "  version        : Prints the current version."
    puts "  input          : Specify a file to use for a initial graph."
    puts "  output         : Specify a file to print the resultant graph to."
    puts "  validate       : Parses the programme and graph, doesn't execute, but outputs any errors." # TODO
    puts "  trace          : Creates interim graph files throughout the execution of the programme."
    puts "  trace-dir      : Specify a directory for the trace graphs to be created in."
    puts "  ignore-colours : Don't add any colour styling to nodes/edges with colour-valued marks."    # TODO
    puts "  merge-colours  : Have a node/edge be the average of any colour-valued marks it has."       # TODO
    puts "  keep-rationals : Keep any rational numeric values as fractions in the resultant graph."    # TODO
    puts "  dot            : Output the resultant graph in the dot format."
    puts "  graphML        : Output the resultant graph in the GraphML format."
    puts "  blossom        : Output the resultant graph in the blossom format (this is the default)."
    puts
    puts "  (unimp) = NOT YET IMPLEMENTED"
    puts
    puts "Examples:"
    puts
    puts "  ./blossom examples/simple_dijkstra.blsm \"[1(0), 2, 3, 4 | 1->2(3), 1->3(5), 2->3(1), 2->4(4), 3->5(2), 4->5(2) ]\""
    puts "  ./blossom examples/2_colouring.blsm --input examples/3x3grid"
    puts
    puts "Report any problems, ask questions, or browse the source at https://github.com/IMP1/blossom"
    exit(ExitCode::OK)
end

if ARGV.include?("-h")
    puts "Blossom Interpreter v#{VERSION}"
    puts
    puts USAGE
    puts
    puts "Report any problems, ask questions, or browse the source at https://github.com/IMP1/blossom"
    exit(ExitCode::OK)
end

if ARGV.include?("--version")
    puts "blossom version #{VERSION}"
    exit(ExitCode::OK)
end

require_relative 'main'
require_relative 'tracer'
require_relative 'graph_formatter'

# Host Graph
if ARGV.count {|a| a == "-i" || a == "--input" } > 1
    puts "Multiple input arguments were included (-i and/or --input). Exiting."
    exit(ExitCode::USAGE)
end

host_graph_filename = "console"
host_graph_file = $stdin

host_graph_index = ARGV.index("-i") || ARGV.index("--input")
if host_graph_index
    ARGV.delete_at(host_graph_index)
    host_graph_filename = ARGV.delete_at(host_graph_index)
    if host_graph_filename.nil?
        puts "A filepath must be supplied as an input file."
        exit(ExitCode::USAGE)
    end
    if !File.exists?(host_graph_filename)
        puts "Could not find graph file '#{host_graph_filename}'. Exiting."
        exit(ExitCode::NOINPUT)
    else
        begin
            host_graph_file = File.open(host_graph_filename, 'r')
        rescue SystemCallError => e
            p e
            puts e.class
            
            # TODO: handle system errors and return appropriate exit codes.
            # http://blog.honeybadger.io/understanding-rubys-strange-errno-exceptions/

            puts "You don't have sufficient permissions to access the input graph file."
            exit(ExitCode::NOPERM)
        end
        
    end
end


# Output File
if ARGV.count {|a| a == "-o" || a == "--output" } > 1
    puts "Multiple output arguments were included (-o and/or --output). Exiting."
    exit(ExitCode::USAGE)
end

output_file = $stdout.dup

output_index = ARGV.index("-o") || ARGV.index("--output")
if output_index
    ARGV.delete_at(output_index)
    output_filename = ARGV.delete_at(output_index)
    if output_filename.nil?
        puts "A filepath must be supplied as an output file."
        exit(ExitCode::USAGE)
    end
    begin
        output_file = File.open(output_filename, 'w')
    rescue SystemCallError => e
        p e
        puts e.class

        # TODO: handle system errors and return appropriate exit codes.
        # http://blog.honeybadger.io/understanding-rubys-strange-errno-exceptions/
        
        puts "You don't have sufficient permissions to create the output file."
        exit(ExitCode::CANTCREAT) # or ExitCode::NOPERM ?
    end
end


# Debugging
if ARGV.count {|a| a == "--debug" } > 1
    puts "Multiple debug arguments were included (--debug). Exiting."
    exit(ExitCode::USAGE)
end
$verbose ||= ARGV.delete("--debug")

# Only Validate Source Code
if ARGV.count {|a| a == "--validate" } > 1
    puts "Multiple validate arguments were included (--validate). Exiting."
    exit(ExitCode::USAGE)
end
validate = ARGV.delete("--validate")

# Tracing
if ARGV.count {|a| a == "--trace" } > 1
    puts "Multiple trace arguments were included (--trace). Exiting."
    exit(ExitCode::USAGE)
end
tracing = ARGV.delete("--trace")

if ARGV.count {|a| a == "--trace-dir" } > 1
    puts "Multiple trace arguments were included (--trace-dir). Exiting."
    exit(ExitCode::USAGE)
end
trace_index = ARGV.index("--trace-dir")
if trace_index
    ARGV.delete_at(trace_index)
    trace_directory = ARGV.delete_at(trace_index)
    if trace_directory.nil?
        puts "A path must be supplied as a trace directory."
        exit(ExitCode::USAGE)
    end
    begin
        Dir.mkdir(trace_directory)
    rescue SystemCallError => e
        p e
        puts e.class

        # TODO: handle system errors and return appropriate exit codes.
        # http://blog.honeybadger.io/understanding-rubys-strange-errno-exceptions/
        
        puts "You don't have sufficient permissions to create the trace directory."
        exit(ExitCode::CANTCREAT) # or ExitCode::NOPERM ?
    end
end

# Output Format
if ARGV.count {|a| a == "--dot" || a == "--graphML" || a == "--blossom" } > 1
    puts "Multiple output formats were included (--dot, --graphML and/or --blossom). Exiting."
    exit(ExitCode::USAGE)
end

output_format = nil
if ARGV.count {|a| a == "--dot" } == 1
    output_format = :dot
    ARGV.delete("--dot")
elsif ARGV.count {|a| a == "--graphML" } == 1
    output_format = :graph_ml
    ARGV.delete("--graphML")
elsif ARGV.count {|a| a == "--blossom" } == 1
    output_format = :blossom
    ARGV.delete("--blossom")
else
    output_format = :blossom
end

# Any Other Arguments
valid = true
ARGV.select {|a| a[0] == "-" }.each do |a|
    puts "Unrecognised option '#{a}'."
    valid = false
end
exit(ExitCode::USAGE) if !valid


# Programme Filename
if ARGV.size > 0
    programme_filename = ARGV.delete_at(0)
else
    programme_filename = gets.chomp
end
if !File.exists?(programme_filename)
    puts "Could not find programme file '#{programme_filename}'. Exiting."
    exit(ExitCode::NOINPUT)
end
programme_file = File.open(programme_filename, 'r')
programme_source = programme_file.read

if host_graph_file != $stdin
    host_graph = host_graph_file.read
elsif ARGV.size > 0
    host_graph = ARGV.delete_at(0)
else
    host_graph = gets.chomp
end

options = {
    only_validate: !!validate,
    tracing: !!tracing,
    trace_dir: trace_directory,
}
output_graph = Runner.run(programme_source, host_graph, programme_filename, host_graph_filename, options)
$stdout.flush

# TODO: other output options (rationals, colours, ...)

output_file.write(GraphFormatter.format(output_graph, output_format))
output_file.write("\n")
output_file.flush
output_file.close